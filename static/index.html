<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>CoTalk ğŸ¥¤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <style>
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Apple SD Gothic Neo', sans-serif; background: #b2c7d9; }
        
        /* ì•± ì „ì²´ ì»¨í…Œì´ë„ˆ (JSë¡œ ë†’ì´ ì¡°ì ˆë¨) */
        #app {
            display: flex;
            flex-direction: column;
            height: 100%; 
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            position: relative;
        }

        header {
            background: #fef01b;
            padding: 12px;
            font-weight: bold;
            color: #3b1e1e;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            z-index: 10;
        }

        /* ì±„íŒ… ì˜ì—­ */
        #chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #b2c7d9;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth; /* ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
        }

        /* ë” ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ */
        #load-more-btn {
            align-self: center;
            background: rgba(0,0,0,0.1);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            color: #555;
            font-size: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            display: none; /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
        }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .msg-row { display: flex; flex-direction: column; max-width: 70%; }
        .nick { font-size: 12px; color: #555; margin-bottom: 4px; margin-left: 2px; }
        .bubble {
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.4;
            word-break: break-all;
            position: relative;
        }
        .time { font-size: 10px; color: #555; margin: 0 4px; align-self: flex-end; white-space: nowrap; }
        
        /* ìƒëŒ€ë°© */
        .msg-row.other { align-self: flex-start; }
        .msg-row.other .bubble { border-top-left-radius: 0; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        
        /* ë‚˜ */
        .msg-row.my { align-self: flex-end; align-items: flex-end; }
        .msg-row.my .nick { display: none; }
        .msg-row.my .bubble { border-top-right-radius: 0; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .bubble-wrap { display: flex; align-items: flex-end; }
        .msg-row.my .bubble-wrap { flex-direction: row-reverse; }

        /* ì…ë ¥ì°½ ì˜ì—­ */
        #input-area {
            padding: 10px;
            background: #fff;
            display: flex;
            gap: 8px;
            border-top: 1px solid #ddd;
            align-items: center;
        }

        /* + ë²„íŠ¼ ë° ë©”ë‰´ */
        #settings-btn {
            font-size: 20px;
            color: #888;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 5px;
        }
        
        /* ì„¤ì • ë©”ë‰´ íŒì—… */
        #settings-menu {
            position: absolute;
            bottom: 70px;
            left: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            display: none; /* í† ê¸€ */
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 200px;
            z-index: 20;
        }
        #settings-menu button {
            background: #f1f1f1;
            border: none;
            padding: 8px;
            border-radius: 4px;
            text-align: left;
            font-size: 14px;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 16px;
        }
        button[type="submit"] {
            background: #fef01b;
            border: none;
            padding: 0 15px;
            height: 40px;
            border-radius: 20px;
            font-weight: bold;
            color: #3b1e1e;
        }
    </style>
</head>
<body>
    <div id="app">
        <header>CoTalk ğŸ¥¤ <span id="my-info" style="font-size:0.8em; font-weight:normal;"></span></header>
        
        <div id="chat-box">
            <button id="load-more-btn" onclick="loadHistory()">â¬† ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <div id="msg-list"></div>
        </div>

        <div id="settings-menu">
            <label style="font-size:12px; color:#666;">ë‚´ ë§í’ì„  ìƒ‰ìƒ</label>
            <input type="color" id="color-picker" style="width:100%; height:30px; border:none;">
            <button onclick="changeNickname()">ë‹‰ë„¤ì„ ë³€ê²½ (ë¡œê·¸ì•„ì›ƒ)</button>
        </div>

        <form id="input-area" onsubmit="sendMsg(event)">
            <button type="button" id="settings-btn" onclick="toggleSettings()">+</button>
            <input type="text" id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off">
            <button type="submit">ì „ì†¡</button>
        </form>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const msgList = document.getElementById('msg-list');
        const loadBtn = document.getElementById('load-more-btn');
        let myNick = localStorage.getItem('cotalk_nick');
        let myColor = localStorage.getItem('cotalk_color') || '#fef01b'; // ê¸°ë³¸ ë…¸ë‘
        let minID = -1; // í˜ì´ì§•ìš© ì»¤ì„œ

        // [í•µì‹¬] í‚¤ë³´ë“œ ë·°í¬íŠ¸ ë¬¸ì œ í•´ê²° (VisualViewport API)
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                // í‚¤ë³´ë“œê°€ ì˜¬ë¼ì˜¤ë©´ ë†’ì´ê°€ ì¤„ì–´ë“¦ -> ì•± ë†’ì´ë¥¼ ê±°ê¸°ì— ë§ì¶¤
                document.getElementById('app').style.height = `${window.visualViewport.height}px`;
                // í¬ì»¤ìŠ¤ ìƒíƒœë¼ë©´ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
                if(document.activeElement.tagName === 'INPUT') {
                    setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 100);
                }
            });
        }

        // ì´ˆê¸°í™”
        initApp();

        async function initApp() {
            if (!myNick) {
                await performLogin();
            } else {
                // ì €ì¥ëœ ë‹‰ë„¤ì„ì´ ìˆìœ¼ë©´ DB ìƒ‰ìƒ ë™ê¸°í™”
                checkServerColor(myNick);
            }
            updateMyInfo();
            
            // 1. ìµœê·¼ ë©”ì‹œì§€ ë¡œë“œ (History API)
            await loadHistory();
            
            // 2. ì‹¤ì‹œê°„ SSE ì—°ê²°
            connectSSE();
        }

        // ë¡œê·¸ì¸ ì ˆì°¨
        async function performLogin() {
            let nickInput = null;
            while (!nickInput) {
                nickInput = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
            }
            myNick = nickInput;
            localStorage.setItem('cotalk_nick', myNick);
            await checkServerColor(myNick);
        }

        // ì„œë²„ì—ì„œ ë‚´ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
        async function checkServerColor(nick) {
            try {
                const res = await fetch(`/login?nick=${encodeURIComponent(nick)}`);
                const data = await res.json();
                
                if (data.color_code) {
                    // DBì— ìƒ‰ì´ ìˆìœ¼ë©´ ë¬»ì§€ ì•Šê³  ì ìš©
                    myColor = data.color_code;
                } else {
                    // DBì— ìƒ‰ì´ ì—†ìœ¼ë©´ ìƒ‰ìƒ ì„ íƒ ìœ ë„ (í˜¹ì€ ëœë¤)
                    // ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ ë…¸ë‘ìœ¼ë¡œ ë‘ë˜, ì„¤ì •ì°½ì—ì„œ ë°”ê¾¸ê²Œ í•¨
                }
                localStorage.setItem('cotalk_color', myColor);
                document.getElementById('color-picker').value = myColor;
            } catch (e) { console.error(e); }
        }

        function updateMyInfo() {
            document.getElementById('my-info').textContent = `(${myNick})`;
            document.getElementById('color-picker').value = myColor;
        }

        // ì„¤ì • ë©”ë‰´ í† ê¸€
        function toggleSettings() {
            const menu = document.getElementById('settings-menu');
            menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
        }

        // ìƒ‰ìƒ ë³€ê²½ (DB ë°˜ì˜ì€ ë©”ì‹œì§€ ë³´ë‚¼ ë•Œ ë¨)
        document.getElementById('color-picker').addEventListener('change', (e) => {
            myColor = e.target.value;
            localStorage.setItem('cotalk_color', myColor);
            toggleSettings(); // ë‹«ê¸°
        });

        // ë‹‰ë„¤ì„ ë³€ê²½
        function changeNickname() {
            if(confirm("ë‹‰ë„¤ì„ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í˜„ì¬ ëŒ€í™”ì°½ì€ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤)")) {
                localStorage.removeItem('cotalk_nick');
                location.reload();
            }
        }

        // ê³¼ê±° ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadHistory() {
            let url = '/history';
            if (minID !== -1) {
                url += `?before_id=${minID}`;
            }

            try {
                const res = await fetch(url);
                const history = await res.json();

                if (history && history.length > 0) {
                    // ID ê°±ì‹  (ê°€ì¥ ì˜¤ë˜ëœ ID ê¸°ì–µ)
                    minID = history[history.length - 1].id;
                    loadBtn.style.display = 'block';

                    // ì—­ìˆœìœ¼ë¡œ ë Œë”ë§ (prepend)
                    // historyëŠ” ìµœì‹ ìˆœ(DESC)ìœ¼ë¡œ ì˜¤ë¯€ë¡œ, ë’¤ì§‘ì§€ ì•Šê³  ìˆœì„œëŒ€ë¡œ ìœ„ì—ì„œë¶€í„° ë¼ì›Œë„£ì–´ì•¼ í•¨?
                    // ì•„ë‹ˆ, ì„œë²„ëŠ” DESC(50, 49, 48...)ë¡œ ì¤Œ.
                    // í™”ë©´ì—” 48, 49, 50 ìˆœìœ¼ë¡œ ìŒ“ì—¬ì•¼ í•¨.
                    // prependë¥¼ í•˜ë ¤ë©´ 50ë„£ê³ , ê·¸ ìœ„ì— 49ë„£ê³ .. ì´ë ‡ê²Œ í•´ì•¼í•¨.
                    
                    // history ë°°ì—´: [ID: 100, ID: 99, ... ID: 70]
                    // í™”ë©´ ìƒë‹¨ì— ë¼ìš¸ë•ŒëŠ” 70ë²ˆë¶€í„° 100ë²ˆ ìˆœì„œë¡œ ìŒ“ì¸ ë¸”ë¡ì„ í†µì§¸ë¡œ ë¼ì›Œì•¼ ìì—°ìŠ¤ëŸ¬ì›€.
                    // ë”°ë¼ì„œ historyë¥¼ reverse í•´ì„œ í•˜ë‚˜ì”© prepend í•˜ê±°ë‚˜
                    // DocumentFragmentë¥¼ ë§Œë“¤ì–´ prepend.
                    
                    const frag = document.createDocumentFragment();
                    // ë°°ì—´ì„ ë’¤ì§‘ì–´ì„œ (ì˜¤ë˜ëœ ê²ƒ -> ìµœì‹  ê²ƒ) ìˆœì„œë¡œ ë§Œë“¬
                    // ì˜ˆ: [70, 71... 100]
                    // ì´ê±¸ ë¦¬ìŠ¤íŠ¸ì˜ ë§¨ ìœ„ì— í•˜ë‚˜ì”© ê½‚ìœ¼ë©´? 
                    // 1. 70 ê½‚ìŒ -> [70]
                    // 2. 71 ê½‚ìŒ (70 ìœ„ì—) -> [71, 70] (X)
                    // ì•„, prependëŠ” ë§¨ ì•ì— ë„£ëŠ” ê²ƒ.
                    // [ê¸°ì¡´: 101, 102]
                    // 100ì„ prepend -> [100, 101, 102]
                    // 99ë¥¼ prepend -> [99, 100, 101, 102]
                    // ì¦‰, ìµœì‹ ìˆœ(DESC) ê·¸ëŒ€ë¡œ í•˜ë‚˜ì”© prepend í•˜ë©´ ë¨!
                    
                    history.forEach(msg => {
                        const row = createMsgRow(msg);
                        msgList.insertBefore(row, msgList.firstChild);
                    });
                    
                    // ì²˜ìŒ ë¡œë”©ì¼ ë•Œë§Œ ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
                    if (url === '/history') {
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                } else {
                    loadBtn.style.display = 'none'; // ë” ì´ìƒ ì—†ìŒ
                    if (minID === -1) {
                        // ì•„ì˜ˆ ê¸€ì´ í•˜ë‚˜ë„ ì—†ëŠ” ê²½ìš°
                    } else {
                        alert("ë§ˆì§€ë§‰ ëŒ€í™”ì…ë‹ˆë‹¤.");
                    }
                }
            } catch (e) { console.error(e); }
        }

        // SSE ì—°ê²°
        function connectSSE() {
            const evtSource = new EventSource("/stream");
            evtSource.onmessage = function(e) {
                const data = JSON.parse(e.data);
                const row = createMsgRow(data);
                msgList.appendChild(row); // ìƒˆ ë©”ì‹œì§€ëŠ” ì•„ë˜ì— ì¶”ê°€
                chatBox.scrollTop = chatBox.scrollHeight;
            };
        }

        // ë©”ì‹œì§€ HTML ìƒì„±
        function createMsgRow(data) {
            const isMe = data.sender_nick === myNick;
            const row = document.createElement('div');
            row.className = `msg-row ${isMe ? 'my' : 'other'}`;
            
            // ë§í’ì„  ìƒ‰ìƒ: ë‚´êº¼ë©´ ë‚´ ì„¤ì •ìƒ‰, ë‚¨êº¼ë©´ DBì—ì„œ ì˜¨ ìƒ‰
            // ë‚¨ì˜ ë©”ì‹œì§€ëŠ” data.sender_colorê°€ DBì—ì„œ ì¡°íšŒëœ ê°’ì„ (ì—†ìœ¼ë©´ í°ìƒ‰)
            // ë‚´ ë©”ì‹œì§€ë¼ë„ ì„œë²„ ê°”ë‹¤ ì˜¨ ê±°ë©´ data.sender_color ì‚¬ìš©
            // ë‹¤ë§Œ, "ë‚˜"ëŠ” ë‚´ ë¡œì»¬ ì„¤ì •(myColor)ì„ ìš°ì„  ë³´ì—¬ì£¼ëŠ” ê²Œ UXìƒ ìì—°ìŠ¤ëŸ¬ì›€ (ë³€ê²½ ì¦‰ì‹œ ë°˜ì˜ ìœ„í•´)
            
            const bubbleColor = isMe ? myColor : (data.sender_color || '#ffffff');
            
            // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²°ì • (ë°°ê²½ì´ ì–´ë‘ìš°ë©´ ê¸€ì í°ìƒ‰) -> ê°„ë‹¨íˆ ë°ê¸° ê³„ì‚°ì€ ìƒëµí•˜ê³ , ì¼ë‹¨ ê²€ì •/í°ìƒ‰ ì²˜ë¦¬ í•„ìš”í•˜ì§€ë§Œ
            // ì—¬ê¸°ì„  ì‹¬í”Œí•˜ê²Œ: ë…¸ë€ ê³„ì—´ì´ë©´ ê²€ì • ê¸€ì”¨, ê·¸ ì™¸ì—”... ì¼ë‹¨ ê²€ì •ìœ¼ë¡œ í†µì¼í•˜ê² ìŠµë‹ˆë‹¤.
            
            row.innerHTML = `
                <span class="nick">${data.sender_nick}</span>
                <div class="bubble-wrap">
                    <div class="bubble" style="background-color: ${bubbleColor};">${data.content}</div>
                    <span class="time">${data.time}</span>
                </div>
            `;
            return row;
        }

        function sendMsg(e) {
            e.preventDefault();
            const input = document.getElementById('msg');
            const msg = input.value;
            if (!msg) return;

            // ë‹‰ë„¤ì„, ìƒ‰ìƒ, ë©”ì‹œì§€ ì „ì†¡
            fetch('/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `msg=${encodeURIComponent(msg)}&nick=${encodeURIComponent(myNick)}&color=${encodeURIComponent(myColor)}`
            });
            input.value = '';
            input.focus();
        }
    </script>
</body>
</html>