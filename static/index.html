<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>CoTalk ğŸ¥¤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* í™”ë©´ ì „ì²´ë¥¼ ê½‰ ì±„ìš°ëŠ” Flex ë ˆì´ì•„ì›ƒ */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Apple SD Gothic Neo', sans-serif; background: #b2c7d9; }
        
        #app {
            display: flex;
            flex-direction: column;
            height: 100dvh; /* ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ë†’ì´ ì´ìŠˆ í•´ê²°ìš© ë‹¨ìœ„ */
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
        }

        /* ì±„íŒ…ì°½ í—¤ë” */
        header {
            background: #fef01b; /* ì¹´â—‹ì˜¤í†¡ ëŠë‚Œ */
            padding: 15px;
            font-weight: bold;
            color: #3b1e1e;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* ë©”ì‹œì§€ ëª©ë¡ (ìŠ¤í¬ë¡¤ ì˜ì—­) */
        #chat-box {
            flex: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
            overflow-y: auto;
            padding: 15px;
            background: #b2c7d9;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ë©”ì‹œì§€ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .msg-row {
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }
        
        .nick {
            font-size: 12px;
            color: #555;
            margin-bottom: 4px;
            margin-left: 2px;
        }
        
        .bubble {
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            word-break: break-all;
        }

        .time {
            font-size: 10px;
            color: #555;
            align-self: flex-end; /* ë§í’ì„  ì˜† í•˜ë‹¨ */
            margin: 0 4px;
        }

        /* ìƒëŒ€ë°© ë©”ì‹œì§€ (ì™¼ìª½) */
        .msg-row.other {
            align-self: flex-start;
        }
        .msg-row.other .bubble {
            background: #ffffff;
            border-top-left-radius: 0;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        /* ë‚´ ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½) */
        .msg-row.my {
            align-self: flex-end;
            align-items: flex-end;
        }
        .msg-row.my .nick {
            display: none; /* ë‚´ ë‹‰ë„¤ì„ì€ êµ³ì´ ì•ˆ ë³´ì—¬ì¤Œ */
        }
        .msg-row.my .bubble {
            background: #fef01b;
            border-top-right-radius: 0;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        /* ë©”ì‹œì§€ + ì‹œê°„ ì»¨í…Œì´ë„ˆ */
        .bubble-wrap {
            display: flex;
            align-items: flex-end;
        }
        .msg-row.my .bubble-wrap { flex-direction: row-reverse; } /* ë‚´êº¼ëŠ” ì‹œê°„ ì™¼ìª½ */

        /* ì…ë ¥ì°½ ì˜ì—­ */
        #input-area {
            padding: 10px;
            background: #fff;
            display: flex;
            gap: 10px;
            border-top: 1px solid #ddd;
        }
        input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 16px; /* 16px ì´ìƒì´ì–´ì•¼ iOSì—ì„œ í™•ëŒ€ ì•ˆ ë¨ */
        }
        button {
            background: #fef01b;
            border: none;
            padding: 0 20px;
            border-radius: 20px;
            font-weight: bold;
            color: #3b1e1e;
            cursor: pointer;
        }
        button:active { opacity: 0.8; }
    </style>
</head>
<body>
    <div id="app">
        <header>CoTalk ğŸ¥¤ <span id="my-nick-display" style="font-size:0.8em; font-weight:normal;"></span></header>
        <div id="chat-box"></div>
        <form id="input-area" onsubmit="sendMsg(event)">
            <input type="text" id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off">
            <button type="submit">ì „ì†¡</button>
        </form>
    </div>

    <script>
        // 1. ë‹‰ë„¤ì„ ì„¤ì • ë¡œì§
        let myNick = localStorage.getItem('cotalk_nick');
        
        while (!myNick) {
            myNick = prompt("ì‚¬ìš©í•˜ì‹¤ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            if (myNick) {
                localStorage.setItem('cotalk_nick', myNick);
            }
        }
        document.getElementById('my-nick-display').textContent = `(${myNick})`;

        const chatBox = document.getElementById('chat-box');
        
        // 2. ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹  (SSE)
        const evtSource = new EventSource("/stream");
        evtSource.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            // ë‚´ ë‹‰ë„¤ì„ê³¼ ë³´ë‚¸ ì‚¬ëŒ ë‹‰ë„¤ì„ ë¹„êµ
            const isMe = data.sender_nick === myNick;
            
            const row = document.createElement('div');
            row.className = `msg-row ${isMe ? 'my' : 'other'}`;
            
            row.innerHTML = `
                <span class="nick">${data.sender_nick}</span>
                <div class="bubble-wrap">
                    <div class="bubble">${data.content}</div>
                    <span class="time">${data.time}</span>
                </div>
            `;
            
            chatBox.appendChild(row);
            chatBox.scrollTop = chatBox.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
        };

        // 3. ë©”ì‹œì§€ ì „ì†¡
        function sendMsg(e) {
            e.preventDefault();
            const input = document.getElementById('msg');
            const msg = input.value;
            if (!msg) return;

            // ë‹‰ë„¤ì„ë„ ê°™ì´ ë³´ëƒ„ (&nick=...)
            fetch('/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `msg=${encodeURIComponent(msg)}&nick=${encodeURIComponent(myNick)}`
            });
            input.value = '';
            input.focus();
        }
    </script>
</body>
</html>